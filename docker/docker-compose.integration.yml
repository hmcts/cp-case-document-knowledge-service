services:
  azurite:
    container_name: cdks_azure_storage
    image: mcr.microsoft.com/azure-storage/azurite:3.33.0
    command: azurite-blob --loose --blobHost 0.0.0.0 --blobPort 10000 --skipApiVersionCheck
    ports:
      - "10000:10000"
    restart: unless-stopped

  azurite-seed:
    container_name: cdks_azurite_seed
    image: mcr.microsoft.com/azure-cli:2.63.0
    depends_on:
      azurite:
        condition: service_started
    environment:
      AZURE_STORAGE_CONNECTION_STRING: "${AZURE_STORAGE_CONNECTION_STRING}"
    volumes:
      - ../src/integrationTest/resources/wiremock-seed:/seed:ro
      - ../src/integrationTest/resources/wiremock-seed/azurite-seed.sh:/azurite-seed.sh:ro
    entrypoint: ["/bin/sh", "/azurite-seed.sh"]
    restart: "no"
    
  artemis:
    container_name: cdks_artemis
    build:
      context: ./artemis
      args:
        - ARTEMIS_BASE_IMAGE
    ports:
      - "61617:61617"
      - "8161:8161"
    environment:
      ACTIVEMQ_ENABLED_AUTH: "false"
    volumes:
      - artemis-data:/var/lib/artemis-instance/data
      - ./artemis/broker.xml:/var/lib/artemis-instance/etc/broker.xml:ro
      - ../src/integrationTest/resources/ssl/keystore.jks:/var/lib/artemis-instance/etc/keystore.jks:ro
    restart: unless-stopped

  db:
    image: postgres:16-alpine
    container_name: cdks_database
    environment:
      POSTGRES_DB: casedocumentknowledgeDatabase
      POSTGRES_USER: casedocumentknowledge
      POSTGRES_PASSWORD: casedocumentknowledge
    ports:
      - "55432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U casedocumentknowledge -d casedocumentknowledgeDatabase"]
      interval: 5s
      timeout: 3s
      retries: 30
    restart: unless-stopped

  wiremock:
    image: wiremock/wiremock:3.9.1
    container_name: cdks_wiremock
    ports:
      - "8089:8080"
    volumes:
      - ../src/integrationTest/resources/wiremock/mappings:/home/wiremock/mappings
      - ../src/integrationTest/resources/wiremock/__files:/home/wiremock/__files
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/__admin/health || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 10
    restart: unless-stopped

  app:
    container_name: cdks_application
    build:
      context: ..
      dockerfile: docker/Dockerfile
    depends_on:
      db:
        condition: service_healthy
      artemis:
        condition: service_started
      wiremock:
        condition: service_started
      azurite-seed:
        condition: service_completed_successfully
    ports:
      - "8082:8082"
      - "5005:5005"
    environment:
      JAVA_TOOL_OPTIONS: -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005

      CP_CDK_RAG_CONNECTION_TIMEOUT_MS: 3000
      CP_CDK_RAG_READ_TIMEOUT_MS: 180000
      CP_CDK_CQRS_CONNECTION_TIMEOUT_MS: 3000
      CP_CDK_CQRS_READ_TIMEOUT_MS: 15000

      CP_CDK_AZURE_POLL_INTERVAL_MS: 5000
      CP_CDK_AZURE_TIMEOUT_SECONDS: 300
      CP_CDK_INGESTION_CORE_POOL_SIZE: 8
      CP_CDK_INGESTION_MAX_POOL_SIZE: 16
      CP_CDK_INGESTION_QUEUE_CAPACITY: 64
      CDK_RETRY_MAX_WAIT_MS: 10
      CDK_RETRY_BACKOFF_INITIAL_MS: 1000
      CDK_RETRY_BACKOFF_MAX_MS: 15000

      CP_CDK_JMS_SESSION_CACHE_SIZE: 5

      CP_CDK_DB_CONNECTION_TIMEOUT: 300000
      CP_CDK_DB_IDLE_TIMEOUT: 600000
      CP_CDK_DB_MAX_LIFETIME: 1800000
      CP_CDK_DB_KEEPLIVE_TIME: 300000
      CP_CDK_DB_AUTO_COMMIT: "false"
      CP_CDK_DB_VALIDATION_TIMEOUT: 5000

      CP_CDK_DATASOURCE_URL: jdbc:postgresql://db:5432/casedocumentknowledgeDatabase
      CP_CDK_DATASOURCE_USERNAME: casedocumentknowledge
      CP_CDK_DATASOURCE_PASSWORD: casedocumentknowledge

      SERVER_PORT: 8082
      SERVER_SERVLET_CONTEXT_PATH: /casedocumentknowledge-service
      SPRING_APPLICATION_NAME: cp-case-document-knowledge-service

      CP_CDK_ARTEMIS_HOST_PRIMARY: artemis
      CP_CDK_ARTEMIS_PORT: 61617
      CP_CDK_ARTEMIS_SSL_ENABLED: "true"
      CP_CDK_ARTEMIS_VERIFY_HOST: "false"

      CP_CDK_JMS_RETRY_INTERVAL_MS: 100
      CP_CDK_JMS_RECONNECT_ATTEMPTS: 0
      CP_CDK_JMS_INITIAL_CONNECT_ATTEMPTS: 10
      CP_CDK_JMS_CONNECTION_TTL_MS: 15000
      CP_CDK_JMS_CALL_TIMEOUT_MS: 3000

      CP_CDK_ARTEMIS_HA: "false"
      MANAGEMENT_HEALTH_JMS_ENABLED: "false"

      CP_CDK_REST_SPECIFICATION: case-admin-doc-knowledge-api.openapi.yml
      CDK_INGEST_VERIFY_MAX_WAIT_MS: 10000

      LOGGING_LEVEL_org.flywaydb: "DEBUG"
      MANAGEMENT_TRACING_ENABLED: "false"
      TRACING_ENABLED: "false"

      CP_CDK_DB_POOL_SIZE: 20
      CP_CDK_DB_MIN_IDLE: 5
      MANAGEMENT_SERVER_PORT: 8082

      CLUSTER_NAME: local
      REGION: local

      TRACING_SAMPLER_PROBABILITY: 1.0
      OTEL_METRICS_ENABLED: "false"
      OTEL_TRACES_URL: http://localhost:4318/traces
      OTEL_METRICS_URL: http://localhost:4318/metrics

      CP_CDK_STORAGE_MODE: connection-string
      CP_CDK_AZURE_STORAGE_CONNECTION_STRING: "${AZURE_STORAGE_CONNECTION_STRING}"
      CP_CDK_AZURE_STORAGE_CONTAINER: documents
      CDK_STORAGE_AZURE_MODE: connection-string
      CDK_STORAGE_AZURE_CONNECTION_STRING: "${AZURE_STORAGE_CONNECTION_STRING}"
      CDK_STORAGE_AZURE_CONTAINER: documents

      CP_CDK_RAG_URL: http://wiremock:8080
      CP_CDK_RAG_SUBSCRIPTION_KEY: dummy-key
      CP_CDK_CJSCPPUID_HEADER: CJSCPPUID
      CP_CDK_BASE_URL: http://wiremock:8080

    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8082/casedocumentknowledge-service/actuator/health || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 12
    restart: unless-stopped

volumes:
  artemis-data: {}
